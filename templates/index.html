<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSM Speech Generator</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>CSM Speech Generator</h1>
            <p>Generate natural-sounding speech using Apple's MLX framework</p>
        </header>

        <main>
            <div class="input-section">
                <div class="text-input">
                    <h2>Enter Text</h2>
                    <textarea id="text-input" placeholder="Type or paste your text here...">Hello! This is a test of the Conversation Speech Model running on Apple Silicon with MLX.</textarea>
                </div>

                <div class="voice-settings">
                    <h2>Voice Settings</h2>
                    
                    <div class="setting voice-type-selector">
                        <label>Voice Type</label>
                        <div class="voice-buttons">
                            <button id="male-voice" class="voice-btn active">Male Voice</button>
                            <button id="female-voice" class="voice-btn">Female Voice</button>
                        </div>
                    </div>
                    
                    <div class="setting">
                        <label for="temperature">Expressiveness <span class="setting-value" id="temperature-value">0.7</span></label>
                        <div class="range-container">
                            <input type="range" id="temperature" min="0.1" max="1.0" step="0.05" value="0.7">
                        </div>
                        <small>Higher = more natural, human-like speech with variations</small>
                    </div>

                    <div class="setting">
                        <label for="min-p">Speech Clarity <span class="setting-value" id="min-p-value">0.05</span></label>
                        <div class="range-container">
                            <input type="range" id="min-p" min="0.01" max="0.2" step="0.01" value="0.05">
                        </div>
                        <small>Lower = more expressive, natural-sounding speech</small>
                    </div>

                    <div class="setting">
                        <label for="speech-speed">Speech Speed <span class="setting-value" id="speed-value">1.0</span></label>
                        <div class="range-container">
                            <input type="range" id="speech-speed" min="0.7" max="1.3" step="0.05" value="1.0">
                        </div>
                        <small>Higher = faster speech pace (post-processing)</small>
                    </div>

                    <div class="setting">
                        <label for="max-duration">Max Duration (ms)</label>
                        <input type="number" id="max-duration" min="1000" max="60000" step="1000" value="30000">
                        <small>30000 = 30 seconds, increase for longer text</small>
                    </div>
                </div>
            </div>

            <div class="actions">
                <button id="generate-btn" class="primary-btn">Generate Speech</button>
            </div>

            <div id="result-section" class="result-section hidden">
                <h2>Generated Speech</h2>
                <div class="audio-player">
                    <audio id="audio-player" controls></audio>
                </div>
                <div id="audio-stats" class="audio-stats">
                    <div class="stat">
                        <span class="stat-label">Duration:</span>
                        <span id="audio-duration" class="stat-value">0.00s</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Generation Time:</span>
                        <span id="generation-time" class="stat-value">0.00s</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Real-time Factor:</span>
                        <span id="real-time-factor" class="stat-value">0.0x</span>
                    </div>
                </div>
                <div class="download-section">
                    <a id="download-link" href="#" class="download-btn" download>Download Audio</a>
                </div>
            </div>

            <div id="history-section" class="history-section">
                <h2>Generation History</h2>
                <div id="history-items" class="history-items">
                    <!-- History items will be added here -->
                </div>
            </div>

            <div id="loading" class="loading hidden">
                <div class="spinner"></div>
                <p>Generating speech...</p>
            </div>
        </main>

        <footer>
            <p>Powered by CSM (Conversation Speech Model) with MLX for Apple Silicon</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get elements
            const textInput = document.getElementById('text-input');
            const maleVoiceBtn = document.getElementById('male-voice');
            const femaleVoiceBtn = document.getElementById('female-voice');
            const temperatureSlider = document.getElementById('temperature');
            const temperatureValue = document.getElementById('temperature-value');
            const minPSlider = document.getElementById('min-p');
            const minPValue = document.getElementById('min-p-value');
            const speedSlider = document.getElementById('speech-speed');
            const speedValue = document.getElementById('speed-value');
            const maxDuration = document.getElementById('max-duration');
            const generateBtn = document.getElementById('generate-btn');
            const resultSection = document.getElementById('result-section');
            const audioPlayer = document.getElementById('audio-player');
            const audioDuration = document.getElementById('audio-duration');
            const generationTime = document.getElementById('generation-time');
            const realTimeFactor = document.getElementById('real-time-factor');
            const downloadLink = document.getElementById('download-link');
            const historyItems = document.getElementById('history-items');
            const loading = document.getElementById('loading');
            
            // Default to male voice
            let currentSpeakerId = 2;
            
            // Voice button handling
            maleVoiceBtn.addEventListener('click', function() {
                maleVoiceBtn.classList.add('active');
                femaleVoiceBtn.classList.remove('active');
                currentSpeakerId = 2;
            });
            
            femaleVoiceBtn.addEventListener('click', function() {
                femaleVoiceBtn.classList.add('active');
                maleVoiceBtn.classList.remove('active');
                currentSpeakerId = 4;
            });
            
            // Update slider values
            temperatureSlider.addEventListener('input', function() {
                temperatureValue.textContent = this.value;
            });
            
            minPSlider.addEventListener('input', function() {
                minPValue.textContent = this.value;
            });
            
            speedSlider.addEventListener('input', function() {
                speedValue.textContent = this.value;
            });
            
            // Audio playback rate adjustment
            audioPlayer.addEventListener('loadedmetadata', function() {
                audioPlayer.playbackRate = parseFloat(speedSlider.value);
            });
            
            // Speed change affects playback rate
            speedSlider.addEventListener('change', function() {
                if (audioPlayer.src) {
                    audioPlayer.playbackRate = parseFloat(this.value);
                }
            });
            
            // Generate speech
            generateBtn.addEventListener('click', function() {
                const text = textInput.value.trim();
                if (!text) {
                    alert('Please enter some text to generate speech.');
                    return;
                }
                
                // Show loading indicator
                loading.classList.remove('hidden');
                resultSection.classList.add('hidden');
                
                // Prepare form data
                const formData = new FormData();
                formData.append('text', text);
                formData.append('speaker', currentSpeakerId);
                formData.append('temperature', temperatureSlider.value);
                formData.append('min_p', minPSlider.value);
                formData.append('max_duration', maxDuration.value);
                
                // Send request
                fetch('/generate', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update audio player
                        audioPlayer.src = data.audio_path;
                        // Set playback rate after the audio is loaded
                        audioPlayer.addEventListener('loadedmetadata', function onceLoaded() {
                            audioPlayer.playbackRate = parseFloat(speedSlider.value);
                            audioPlayer.removeEventListener('loadedmetadata', onceLoaded);
                        });
                        
                        audioDuration.textContent = data.duration + 's';
                        generationTime.textContent = data.generation_time + 's';
                        realTimeFactor.textContent = data.real_time_factor + 'x';
                        
                        // Set download link to use the download path
                        downloadLink.href = data.download_path || data.audio_path;
                        downloadLink.download = data.filename;
                        
                        // Show result section
                        resultSection.classList.remove('hidden');
                        
                        // Get voice name
                        let voiceName = currentSpeakerId === 2 ? "Male Voice" : "Female Voice";
                        voiceName += ` (T:${temperatureSlider.value}, P:${minPSlider.value}, S:${speedSlider.value})`;
                        
                        // Add to history
                        addToHistory(
                            text, 
                            currentSpeakerId, 
                            data.audio_path,
                            data.download_path || data.audio_path,
                            voiceName
                        );
                    } else {
                        alert('Error generating speech: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while generating speech.');
                })
                .finally(() => {
                    // Hide loading indicator
                    loading.classList.add('hidden');
                });
            });
            
            // Add to history
            function addToHistory(text, speakerId, audioPath, downloadPath, voiceName) {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const truncatedText = text.length > 50 ? text.substring(0, 47) + '...' : text;
                
                historyItem.innerHTML = `
                    <div class="history-text">${truncatedText}</div>
                    <div class="history-speaker">${voiceName}</div>
                    <div class="history-actions">
                        <button class="play-btn">Play</button>
                        <a href="${downloadPath}" class="download-small" download>â¬‡</a>
                    </div>
                `;
                
                // Store the current speed value
                const currentSpeed = parseFloat(speedSlider.value);
                
                // Add play functionality
                const playBtn = historyItem.querySelector('.play-btn');
                playBtn.addEventListener('click', function() {
                    audioPlayer.src = audioPath;
                    audioPlayer.addEventListener('loadedmetadata', function onceLoaded() {
                        audioPlayer.playbackRate = currentSpeed;
                        audioPlayer.play();
                        audioPlayer.removeEventListener('loadedmetadata', onceLoaded);
                    });
                    resultSection.classList.remove('hidden');
                });
                
                // Add to history items (insert at the beginning)
                historyItems.insertBefore(historyItem, historyItems.firstChild);
            }
        });
    </script>
</body>
</html>