<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSM Speech Generator</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>CSM Speech Generator</h1>
            <p>Generate natural-sounding speech using Apple's MLX framework</p>
        </header>

        <main>
            <div class="input-section">
                <div class="text-input">
                    <h2>Enter Text</h2>
                    <textarea id="text-input" placeholder="Type or paste your text here...">Hello! This is a test of the Conversation Speech Model running on Apple Silicon with MLX.</textarea>
                </div>

                <div class="voice-settings">
                    <h2>Voice Settings</h2>
                    
                    <div class="setting voice-type-selector">
                        <label>Voice Type</label>
                        <div class="voice-buttons">
                            <button id="male-voice" class="voice-btn active" data-speaker-id="2">Male Voice</button>
                            <button id="female-voice" class="voice-btn" data-speaker-id="4">Female Voice</button>
                        </div>
                    </div>

                    <div class="setting-divider">
                        <span>Fine Tuning</span>
                    </div>
                    
                    <div class="setting">
                        <label for="temperature">Expressiveness <span class="setting-value" id="temperature-value">0.7</span></label>
                        <div class="range-container">
                            <input type="range" id="temperature" min="0.1" max="1.5" step="0.05" value="0.7">
                        </div>
                        <small>Higher = more natural, human-like speech with variations</small>
                    </div>

                    <div class="setting">
                        <label for="min-p">Speech Clarity <span class="setting-value" id="min-p-value">0.05</span></label>
                        <div class="range-container">
                            <input type="range" id="min-p" min="0.01" max="0.2" step="0.01" value="0.05">
                        </div>
                        <small>Lower = more expressive, natural-sounding speech</small>
                    </div>

                    <div class="setting">
                        <label for="speech-speed">Speech Speed <span class="setting-value" id="speed-value">1.0</span></label>
                        <div class="range-container">
                            <input type="range" id="speech-speed" min="0.7" max="1.3" step="0.05" value="1.0">
                        </div>
                        <small>Higher = faster speech pace (post-processing)</small>
                    </div>
                    
                    <div class="setting-divider">
                        <span>Advanced Settings</span>
                    </div>
                    
                    <div class="setting">
                        <label for="random-seed">Random Seed</label>
                        <div class="seed-container">
                            <input type="number" id="random-seed" min="0" max="9999999" value="" placeholder="Random">
                            <button id="generate-seed" class="small-btn">ðŸŽ²</button>
                        </div>
                        <small>Same seed = consistent voice (leave empty for random)</small>
                    </div>
                    
                    <div class="setting">
                        <label for="speaker-id">Speaker ID <span class="setting-value" id="speaker-id-value">2</span></label>
                        <div class="range-container">
                            <input type="range" id="speaker-id-range" min="0" max="9" step="1" value="2">
                        </div>
                        <small>Model has 10 distinct voice identities (0-9)</small>
                    </div>

                    <div class="setting">
                        <label for="max-duration">Max Duration (ms)</label>
                        <input type="number" id="max-duration" min="1000" max="60000" step="1000" value="30000">
                        <small>30000 = 30 seconds, increase for longer text</small>
                    </div>
                </div>
            </div>

            <div class="actions">
                <button id="generate-btn" class="primary-btn">Generate Speech</button>
            </div>

            <div id="result-section" class="result-section hidden">
                <h2>Generated Speech</h2>
                <div class="audio-player">
                    <audio id="audio-player" controls></audio>
                </div>
                <div id="audio-stats" class="audio-stats">
                    <div class="stat">
                        <span class="stat-label">Duration:</span>
                        <span id="audio-duration" class="stat-value">0.00s</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Generation Time:</span>
                        <span id="generation-time" class="stat-value">0.00s</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Real-time Factor:</span>
                        <span id="real-time-factor" class="stat-value">0.0x</span>
                    </div>
                </div>
                <div class="download-section">
                    <a id="download-link" href="#" class="download-btn" download>Download Audio</a>
                </div>
            </div>

            <div id="history-section" class="history-section">
                <h2>Generation History</h2>
                <div id="history-items" class="history-items">
                    <!-- History items will be added here -->
                </div>
            </div>

            <div id="error-message" class="error-message hidden">
                <h3>Error</h3>
                <p id="error-text"></p>
                <button id="close-error" class="close-btn">Close</button>
            </div>

            <div id="loading" class="loading hidden">
                <div class="spinner"></div>
                <p style="font-size: 18px; font-weight: bold;">Generating speech...</p>
                <p style="margin-top: 10px; font-size: 14px;">This may take a few seconds</p>
            </div>
        </main>

        <footer>
            <p>Powered by CSM (Conversation Speech Model) with MLX for Apple Silicon</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const textInput = document.getElementById('text-input');
            const maleVoiceBtn = document.getElementById('male-voice');
            const femaleVoiceBtn = document.getElementById('female-voice');
            const temperatureSlider = document.getElementById('temperature');
            const temperatureValue = document.getElementById('temperature-value');
            const minPSlider = document.getElementById('min-p');
            const minPValue = document.getElementById('min-p-value');
            const speedSlider = document.getElementById('speech-speed');
            const speedValue = document.getElementById('speed-value');
            const speakerIdRange = document.getElementById('speaker-id-range');
            const speakerIdValue = document.getElementById('speaker-id-value');
            const randomSeedInput = document.getElementById('random-seed');
            const generateSeedBtn = document.getElementById('generate-seed');
            const maxDuration = document.getElementById('max-duration');
            const generateBtn = document.getElementById('generate-btn');
            const resultSection = document.getElementById('result-section');
            const audioPlayer = document.getElementById('audio-player');
            const audioDuration = document.getElementById('audio-duration');
            const generationTime = document.getElementById('generation-time');
            const realTimeFactor = document.getElementById('real-time-factor');
            const downloadLink = document.getElementById('download-link');
            const historyItems = document.getElementById('history-items');
            const loadingOverlay = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const closeErrorBtn = document.getElementById('close-error');
            
            // Initialize speaker ID range with the male voice selection
            speakerIdRange.value = maleVoiceBtn.dataset.speakerId;
            speakerIdValue.textContent = maleVoiceBtn.dataset.speakerId;
            
            // Voice button handling
            maleVoiceBtn.addEventListener('click', function() {
                femaleVoiceBtn.classList.remove('active');
                maleVoiceBtn.classList.add('active');
                speakerIdRange.value = maleVoiceBtn.dataset.speakerId;
                speakerIdValue.textContent = maleVoiceBtn.dataset.speakerId;
            });
            
            femaleVoiceBtn.addEventListener('click', function() {
                maleVoiceBtn.classList.remove('active');
                femaleVoiceBtn.classList.add('active');
                speakerIdRange.value = femaleVoiceBtn.dataset.speakerId;
                speakerIdValue.textContent = femaleVoiceBtn.dataset.speakerId;
            });
            
            // Update slider values
            temperatureSlider.addEventListener('input', function() {
                temperatureValue.textContent = this.value;
            });
            
            minPSlider.addEventListener('input', function() {
                minPValue.textContent = this.value;
            });
            
            speedSlider.addEventListener('input', function() {
                speedValue.textContent = this.value;
            });
            
            speakerIdRange.addEventListener('input', function() {
                speakerIdValue.textContent = this.value;
                
                // Update voice buttons based on speaker ID
                if (this.value === maleVoiceBtn.dataset.speakerId) {
                    maleVoiceBtn.classList.add('active');
                    femaleVoiceBtn.classList.remove('active');
                } else if (this.value === femaleVoiceBtn.dataset.speakerId) {
                    femaleVoiceBtn.classList.add('active');
                    maleVoiceBtn.classList.remove('active');
                } else {
                    // Custom voice ID
                    maleVoiceBtn.classList.remove('active');
                    femaleVoiceBtn.classList.remove('active');
                }
            });
            
            // Generate random seed
            generateSeedBtn.addEventListener('click', function() {
                randomSeedInput.value = Math.floor(Math.random() * 1000000);
            });
            
            // Audio playback rate adjustment
            audioPlayer.addEventListener('loadedmetadata', function() {
                audioPlayer.playbackRate = parseFloat(speedSlider.value);
            });
            
            // Speed change affects playback rate
            speedSlider.addEventListener('change', function() {
                if (audioPlayer.src) {
                    audioPlayer.playbackRate = parseFloat(this.value);
                }
            });
            
            // Error message handling
            closeErrorBtn.addEventListener('click', function() {
                errorMessage.classList.add('hidden');
            });
            
            // Generate speech
            generateBtn.addEventListener('click', function() {
                // Validate input
                const text = textInput.value.trim();
                if (!text) {
                    showError('Please enter some text to generate speech.');
                    return;
                }
                
                // Show loading overlay
                loadingOverlay.classList.remove('hidden');
                resultSection.classList.add('hidden');
                
                // Prepare form data
                const formData = new FormData();
                formData.append('text', text);
                formData.append('speaker', speakerIdRange.value);
                formData.append('temperature', temperatureSlider.value);
                formData.append('min_p', minPSlider.value);
                formData.append('max_duration', maxDuration.value);
                
                if (randomSeedInput.value) {
                    formData.append('seed', randomSeedInput.value);
                }
                
                // Send request with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout
                
                fetch('/generate', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Hide loading
                    loadingOverlay.classList.add('hidden');
                    
                    if (data.success) {
                        // Add timestamp to prevent caching
                        const timestamp = new Date().getTime();
                        const audioPath = `${data.audio_path}?t=${timestamp}`;
                        
                        // Update audio player
                        audioPlayer.src = audioPath;
                        
                        // Update stats
                        audioDuration.textContent = data.duration + 's';
                        generationTime.textContent = data.generation_time + 's';
                        realTimeFactor.textContent = data.real_time_factor + 'x';
                        
                        // Set download link
                        downloadLink.href = data.download_path;
                        downloadLink.download = data.filename;
                        
                        // Show result section
                        resultSection.classList.remove('hidden');
                        
                        // Add to history
                        addToHistory(text, data);
                    } else {
                        showError(data.message || 'Unknown error occurred');
                    }
                })
                .catch(error => {
                    // Hide loading
                    loadingOverlay.classList.add('hidden');
                    
                    if (error.name === 'AbortError') {
                        showError('Request timed out. The server took too long to respond.');
                    } else {
                        showError('Error: ' + error.message);
                    }
                    console.error('Error generating speech:', error);
                });
            });
            
            // Add to history
            function addToHistory(text, data) {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                // Truncate text if needed
                const truncatedText = text.length > 50 ? text.substring(0, 47) + '...' : text;
                
                // Get voice name
                let voiceName;
                const speakerId = data.voice_parameters.speaker;
                
                if (speakerId == 2) {
                    voiceName = 'Male Voice';
                } else if (speakerId == 4) {
                    voiceName = 'Female Voice';
                } else {
                    voiceName = `Speaker ${speakerId}`;
                }
                
                // Add parameters to voice name
                const params = data.voice_parameters;
                const seedInfo = params.seed ? ` | Seed: ${params.seed}` : '';
                const voiceInfo = `${voiceName} | T: ${params.temperature} | P: ${params.min_p}${seedInfo}`;
                
                historyItem.innerHTML = `
                    <div class="history-text">${truncatedText}</div>
                    <div class="history-speaker">${voiceInfo}</div>
                    <div class="history-actions">
                        <button class="play-btn">Play</button>
                        <a href="${data.download_path}" class="download-small" download>â¬‡</a>
                    </div>
                `;
                
                // Store data in the history item
                historyItem.dataset.audioPath = data.audio_path;
                historyItem.dataset.speakerId = params.speaker;
                historyItem.dataset.temperature = params.temperature;
                historyItem.dataset.minP = params.min_p;
                historyItem.dataset.seed = params.seed || '';
                historyItem.dataset.speed = speedSlider.value;
                
                // Add play functionality
                const playBtn = historyItem.querySelector('.play-btn');
                playBtn.addEventListener('click', function() {
                    // Add timestamp to prevent caching
                    const timestamp = new Date().getTime();
                    audioPlayer.src = `${historyItem.dataset.audioPath}?t=${timestamp}`;
                    
                    audioPlayer.addEventListener('loadedmetadata', function onceLoaded() {
                        audioPlayer.playbackRate = parseFloat(historyItem.dataset.speed);
                        audioPlayer.play();
                        audioPlayer.removeEventListener('loadedmetadata', onceLoaded);
                    });
                    
                    resultSection.classList.remove('hidden');
                });
                
                // Insert at the beginning of the history
                historyItems.insertBefore(historyItem, historyItems.firstChild);
            }
            
            // Show error message
            function showError(message) {
                errorText.textContent = message;
                errorMessage.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>